---
sidebar_label: Spring Boot
---

import TabItem from '@theme/TabItem';
import Tabs from '@theme/Tabs';

# Spring Bootã§APIã‚’ä¿è­·ã™ã‚‹

:::note

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§APIãƒªã‚½ãƒ¼ã‚¹`http://localhost:3000/`ã‚’ä½œæˆã—ãŸã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚
æº–å‚™ãŒã§ãã¦ã„ãªã„å ´åˆã¯ã€ç¶šè¡Œã™ã‚‹å‰ã«[ã“ã¡ã‚‰](./README.mdx#register-the-api-resources-using-logto-admin-console)ã‚’ã”è¦§ãã ã•ã„ã€‚

:::

ã‚ãªãŸã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Spring Bootãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
ç¾æ™‚ç‚¹ã§ã¯ã€Spring Bootã§Logtoã‚’æ‰‹å‹•ã§çµ±åˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®è¨˜äº‹ã§ã¯ã€ãã®æ‰‹é †ã‚’æ®µéšçš„ã«æ¡ˆå†…ã—ã¾ã™ã€‚
ãã—ã¦ã€ä¾‹ã¨ã—ã¦Gradleã€Javaã€ãŠã‚ˆã³Spring Securityã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## Spring Bootãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã™ã‚‹

[Spring Initializr](https://start.spring.io/)ã‚’ä½¿ç”¨ã—ã¦ã€ç´ æ—©ãSpring Bootãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚
æ¬¡ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š

- Gradleãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
- è¨€èªï¼šJava
- Spring Bootï¼š2.7.2

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã—ã¦é–‹ãã¾ã™ã€‚

## ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã™ã‚‹

Gradleãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ« `build.gradle` ã«ä¾å­˜é–¢ä¿‚ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```groovy
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'
}
```

:::note

Spring Bootã¨Spring Securityã¯OAuth2ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã¨JWTæ¤œè¨¼ã®ãŸã‚ã®çµ„è¾¼ã¿ã‚µãƒãƒ¼ãƒˆãŒã‚ã‚‹ãŸã‚ã€
Logtoã‹ã‚‰ã®çµ±åˆã«è¿½åŠ ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Spring Security OAuth 2.0 Resource Server](https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html)ãŠã‚ˆã³[Spring Security Architecture](https://spring.io/guides/topicals/spring-security-architecture)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

:::

## ç™ºè¡Œè€…ã¨JWKS URIã‚’å–å¾—ã™ã‚‹

ã™ã¹ã¦ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯[ç™ºè¡Œè€…](https://openid.net/specs/openid-connect-core-1_0.html#IssuerIdentifier)ã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚Œã€
[JWK](https://datatracker.ietf.org/doc/html/rfc7517)ã§ç½²åã•ã‚Œã¾ã™ï¼ˆè©³ç´°ã«ã¤ã„ã¦ã¯[JWS](https://datatracker.ietf.org/doc/html/rfc7515)ã‚’å‚ç…§ï¼‰ã€‚

æ¬¡ã«é€²ã‚€å‰ã«ã€Bearer Token (`access_token`) ã®ç™ºè¡Œè€…ã¨ç½²åã®æ¤œè¨¼ã«å¿…è¦ãªç™ºè¡Œè€…ã¨JWKS URIã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€Logtoã®ç™ºè¡Œè€…ãŠã‚ˆã³JWKS URIã¯`https://<your-logto-domain>/oidc`ãŠã‚ˆã³`https://<your-logto-domain>/oidc/jwks`ã§ã™
(ä¾‹ï¼šãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ `http://localhost:3001/oidc` ãŠã‚ˆã³ `http://localhost:3001/oidc/jwks` ã§ã™)ã€‚

:::note

ã™ã¹ã¦ã®æœ€æ–°ã®Logto Authorization Serverã®è¨­å®šæƒ…å ±ã¯ã€`https://<your-logto-domain>/oidc/.well-known/openid-configuration`ã§ç¢ºèªã§ãã¾ã™
ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ã€ `http://localhost:3001/oidc/.well-known/openid-configuration` ãªã©ï¼‰ã€‚
ã“ã‚Œã«ã¯ã€**issuer**ã€**jwks_uri**ã€ãŠã‚ˆã³ãã®ä»–ã®èªå¯ã®è¨­å®šãŒå«ã¾ã‚Œã¾ã™ã€‚
ä¾‹ï¼š

```json
{
  // ...
  "issuer": "https://<your-logto-domain>/oidc",
  "jwks_uri": "https://<your-logto-domain>/oidc/jwks"
  // ...
}
```

:::

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã™ã‚‹

ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆã€ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ã€ãŠã‚ˆã³OAuth2ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã‚’æ§‹æˆã™ã‚‹ãŸã‚ã«ã€`application.yml`ãƒ•ã‚¡ã‚¤ãƒ«
ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®`application.properties`ã§ã¯ãªãï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```yaml
# path/to/project/src/main/resources/application.yaml
server:
  port: 3000

logto:
  audience: http://localhost:3000/

spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: <your-logto-issuer-uri> # ä¾‹ï¼šhttp://localhost:3001/oidc
          jwk-set-uri: <your-logto-jwks-uri> # ä¾‹ï¼šhttp://localhost:3001/oidc/jwks
```

- `audience`:
  ä¿è­·ã•ã‚ŒãŸAPIãƒªã‚½ãƒ¼ã‚¹ã®å›ºæœ‰ã®APIè­˜åˆ¥å­ï¼ˆã¤ã¾ã‚Šã€APIæŒ‡æ¨™ï¼‰ã€‚
- `spring.security.oauth2.resourceserver.jwt.issuer-uri`:
  Logtoã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚ŒãŸJWTå†…ã®`iss`ã‚¯ãƒ¬ãƒ¼ãƒ å€¤ãŠã‚ˆã³ç™ºè¡Œè€…URIã€‚
  å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰`issuer`å€¤ã‚’å…¥åŠ›ã—ã¾ã™ã€‚
- `spring.security.oauth2.resourceserver.jwt.jwk-set-uri`:
  ã“ã®URIã‚’Spring Securityã¯ä½¿ç”¨ã—ã¦ã€JWTã®ç½²åã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®èªå¯ã‚µãƒ¼ãƒãƒ¼ã®å…¬é–‹éµã‚’å–å¾—ã—ã¾ã™ã€‚
  å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰`jwks_uri`å€¤ã‚’å…¥åŠ›ã—ã¾ã™ã€‚

## ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚¿ã‚’æä¾›ã™ã‚‹

`OAuth2TokenValidator`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã™ã‚‹`AudienceValidator`ã‚¯ãƒ©ã‚¹ã‚’æä¾›ã—ã¦ã€
å¿…è¦ãªã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãŒJWTå†…ã«å­˜åœ¨ã™ã‚‹ã‹ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

```java
// path/to/project/src/main/java/io/logto/springboot/sample/validator/AudienceValidator.java
package io.logto.springboot.sample.validator;

import org.springframework.security.oauth2.core.OAuth2Error;
import org.springframework.security.oauth2.core.OAuth2TokenValidator;
import org.springframework.security.oauth2.core.OAuth2TokenValidatorResult;
import org.springframework.security.oauth2.jwt.Jwt;

public class AudienceValidator implements OAuth2TokenValidator<Jwt> {

    private final OAuth2Error oAuth2Error = new OAuth2Error("invalid_token", "Required audience not found", null);

    private final String audience;

    public AudienceValidator(String audience) {
        this.audience = audience;
    }

    @Override
    public OAuth2TokenValidatorResult validate(Jwt jwt) {
        if (!jwt.getAudience().contains(audience)) {
            return OAuth2TokenValidatorResult.failure(oAuth2Error);
        }

        return OAuth2TokenValidatorResult.success();
    }
}
```

:::note
[ğŸ” RBAC](/docs/recipes/rbac)ã®å ´åˆã€ã‚¹ã‚³ãƒ¼ãƒ—ã®æ¤œè¨¼ã‚‚å¿…è¦ã§ã™ã€‚
:::

## Spring Securityã‚’æ§‹æˆã™ã‚‹

Spring Securityã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦ç°¡å˜ã«æ§‹æˆã—ã€
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®Bearer Tokenã‹ã‚‰JWTã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

`JwtDecoder`ãŠã‚ˆã³`SecurityFilterChain`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æä¾›ã—ï¼ˆSpringãƒ“ãƒ¼ãƒ³ã¨ã—ã¦ï¼‰ã€ `@EnableWebSecurity`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```java
// path/to/project/src/main/java/io/logto/springboot/sample/configuration/SecurityConfiguration.java
package io.logto.springboot.sample.configuration;

import com.nimbusds.jose.JOSEObjectType;
import com.nimbusds.jose.proc.DefaultJOSEObjectTypeVerifier;
import com.nimbusds.jose.proc.SecurityContext;
import io.logto.springboot.sample.validator.AudienceValidator;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.oauth2.server.resource.OAuth2ResourceServerConfigurer;
import org.springframework.security.oauth2.core.DelegatingOAuth2TokenValidator;
import org.springframework.security.oauth2.core.OAuth2TokenValidator;
import org.springframework.security.oauth2.jwt.Jwt;
import org.springframework.security.oauth2.jwt.JwtDecoder;
import org.springframework.security.oauth2.jwt.JwtValidators;
import org.springframework.security.oauth2.jwt.NimbusJwtDecoder;
import org.springframework.security.web.SecurityFilterChain;

@EnableWebSecurity
public class SecurityConfiguration {

    @Value("${logto.audience}")
    private String audience;

    @Value("${spring.security.oauth2.resourceserver.jwt.issuer-uri}")
    private String issuer;

    @Value("${spring.security.oauth2.resourceserver.jwt.jwk-set-uri}")
    private String jwksUri;

    @Bean
    public JwtDecoder jwtDecoder() {
        NimbusJwtDecoder jwtDecoder = NimbusJwtDecoder.withJwkSetUri(jwksUri)
                // The decoder should support the token type: Access Token + JWT.
                .jwtProcessorCustomizer(customizer -> customizer.setJWSTypeVerifier(
                        new DefaultJOSEObjectTypeVerifier<SecurityContext>(new JOSEObjectType("at+jwt"))))
                .build();

        jwtDecoder.setJwtValidator(new DelegatingOAuth2TokenValidator<>(
                new AudienceValidator(audience),
                new JwtIssuerValidator(issuer),
                new JwtTimestampValidator()));

        return jwtDecoder;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http.oauth2ResourceServer(OAuth2ResourceServerConfigurer::jwt).cors().and()
                .authorizeRequests(customizer -> customizer
                        // Only authenticated requests can access your protected APIs
                        // e.g. `http://localhost:3000/` and `http://localhost:3000/profile`.
                        .mvcMatchers("/", "/secret").authenticated()
                        // Anyone can access the public profile.
                        .mvcMatchers("/profile").permitAll()
                );
        return http.build();
    }
}
```

## APIã‚’è¿½åŠ ã™ã‚‹

ä¿è­·ã•ã‚ŒãŸAPIãŠã‚ˆã³å…¬é–‹APIã‚’æä¾›ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```java
// path/to/project/src/main/java/io/logto/springboot/sample/controller/ProtectedController.java
package io.logto.springboot.sample.controller;

import org.springframework.web.bind.annotation.CrossOrigin;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

// ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã™ã¹ã¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¨±å¯ã—ã¾ã™ã€‚
// ï¼ˆæœ¬ç•ªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€CORSã‚’æ…é‡ã«æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼‰
@CrossOrigin(origins = "*")
@RestController
public class ProtectedController {

    @GetMapping("/")
    public String protectedRoot() {
        return "Protected root.";
    }

    @GetMapping("/secret")
    public String protectedSecret() {
        return "Protected secret.";
    }

    @GetMapping("/profile")
```java
public String publicProfile() {
    return "Public profile.";
}
```

## ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ä»˜ãAPI

Spring Bootã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦å®Ÿè¡Œã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€`bootRun` Gradleã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

<Tabs>
<TabItem value="linux-or-macos" label="Linuxã¾ãŸã¯macOS">

```bash
./gradlew bootRun
```

</TabItem>
<TabItem value="windows" label="Windows">

```bash
gradlew.bat bootRun
```

</TabItem>
</Tabs>

:::note

ã“ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†å‰ã«APIãƒªã‚½ãƒ¼ã‚¹ `http://localhost:3000/` ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚
æº–å‚™ãŒã§ãã¦ã„ãªã„å ´åˆã¯ã€ç¶šè¡Œã™ã‚‹å‰ã«[ã“ã¡ã‚‰](./README.mdx#integrate-the-resources-authorization-flow-into-your-client-application)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

:::

ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Bearerãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã§ä¿è­·ã•ã‚ŒãŸAPIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚ãŸã¨ãˆã°ã€`curl`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
curl --include 'http://localhost:3000/secret' \
--header 'Authorization: Bearer <your-access-token>'
```

æˆåŠŸã—ãŸå ´åˆã€200ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã¨ã‚‚ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚

```bash
HTTP/1.1 200
...
```

ãã†ã§ãªã„å ´åˆã€æ¬¡ã®ã‚ˆã†ã«401ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã—ã¾ã™ã€‚

```bash
HTTP/1.1 401
...
WWW-Authenticate: Bearer error="invalid_token", error_description="An error occurred while attempting to decode the Jwt: Signed JWT rejected: Invalid signature", error_uri="https://tools.ietf.org/html/rfc6750#section-3.1"
...
```

## ã•ã‚‰ã«èª­ã‚€

- [APIã‚’ä¿è­·ã™ã‚‹](./README.mdx)
- [Spring Security OAuth 2.0ãƒªã‚½ãƒ¼ã‚¹ã‚µãƒ¼ãƒãƒ¼](https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/index.html)
- [Spring Securityã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](https://spring.io/guides/topicals/spring-security-architecture)