---
sidebar_label: ãƒãƒ¼ãƒ‰ï¼ˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹ï¼‰
---

import RetrieveOidcConfiguration from './fragments/_retrieve_oidc_configuration.md';

# ãƒãƒ¼ãƒ‰ï¼ˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ¬ã‚¹ï¼‰ã§APIã‚’ä¿è­·ã™ã‚‹

:::note

ç¶šè¡Œã™ã‚‹å‰ã«ã€[Logtoç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§APIãƒªã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²](./README.mdx#register-the-api-resources-using-logto-admin-console)ã—ã¦ãã ã•ã„ã€‚

:::

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™

èªå¯ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ã€ãã®å†…å®¹ã¨ã—ã¦ `Bearer <access_token>` ã‚’æŒã¤ `Authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ï¼š

```js
// auth_middleware.ts

import { IncomingHttpHeaders } from 'http';

const extractBearerTokenFromHeaders = ({ authorization }: IncomingHttpHeaders) => {
  if (!authorization) {
    throw new Error({ code: 'auth.authorization_header_missing', status: 401 });
  }

  if (!authorization.startsWith('Bearer')) {
    throw new Error({ code: 'auth.authorization_token_type_not_supported', status: 401 });
  }

  return authorization.slice(bearerTokenIdentifier.length + 1);
};
```

## ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼

ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€[jose](https://github.com/panva/jose) ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åã€æœ‰åŠ¹æœŸé™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãŠã‚ˆã³å¿…è¦ãªã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼ã—ã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚ã¨ã—ã¦ `jose` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```sh
npm i jose --save
```

<RetrieveOidcConfiguration />

### èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’è¿½åŠ 

Joseã® `jwtVerify` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®JWSå½¢å¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ç½²åã€ç™ºè¡Œå…ƒã€å—ä¿¡è€…ã€ãŠã‚ˆã³æœ‰åŠ¹æœŸé™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚æ¤œè¨¼ã«å¤±æ•—ã—ãŸå ´åˆã¯ã€ä¾‹å¤–ãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã¾ã™ã€‚

:::note
[ğŸ” RBAC](/docs/recipes/rbac)ã®å ´åˆã€ã‚¹ã‚³ãƒ¼ãƒ—ã®æ¤œè¨¼ã‚‚å¿…è¦ã§ã™ã€‚
:::

```js
// auth-middleware.ts

import { createRemoteJWKSet, jwtVerify } from 'jose';

//...

export const verifyAuthFromRequest = async (req, res, next) => {
  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡ºã™ã‚‹
  const token = extractBearerTokenFromHeaders(req.headers);

  const { payload } = await jwtVerify(
    token, // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–ã‚Šå‡ºã•ã‚ŒãŸç”Ÿã®ãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³
    createRemoteJWKSet('https://<your-logto-domain>/oidc/jwks'), // Logtoã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å•ã„åˆã‚ã›ãŸjwks_uriã‚’ä½¿ç”¨ã—ã¦jwksã‚’ç”Ÿæˆ
    {
      // ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸå¾…ã•ã‚Œã‚‹ç™ºè¡Œè€…ã€Logtoã‚µãƒ¼ãƒãƒ¼ã«ã‚ˆã£ã¦ç™ºè¡Œã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
      issuer: 'https://<your-logto-domain>/oidc',
      // æœŸå¾…ã•ã‚Œã‚‹ã‚ªãƒ¼ãƒ‡ã‚£ã‚¨ãƒ³ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã€ç¾åœ¨ã®APIã®ãƒªã‚½ãƒ¼ã‚¹æŒ‡æ¨™ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
      audience: '<your request listener resource indicator>',
    }
  );

  // RBACã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆ
  assert(payload.scope.includes('some_scope'));

  // ã‚«ã‚¹ã‚¿ãƒ ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯
  userId = payload.sub;

  return next();
};
```

## APIã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã™ã‚‹

```js
import { verifyAuthFromRequest } from '/middleware/auth-middleware.ts';

app.get('/user/:id', verifyAuthFromRequest, (req, res, next) => {
  // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ‰
});
```