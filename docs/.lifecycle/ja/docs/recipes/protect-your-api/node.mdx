---
sidebar_label: ノード（エクスプレス）
---

import RetrieveOidcConfiguration from './fragments/_retrieve_oidc_configuration.md';

# ノード（エクスプレス）でAPIを保護する

:::note

続行する前に、[Logto管理コンソールでAPIリソースを登録](./README.mdx#register-the-api-resources-using-logto-admin-console)してください。

:::

## リクエストヘッダーからベアラートークンを取得します

認可されたリクエストには、その内容として `Bearer <access_token>` を持つ `Authorization` ヘッダーが含まれている必要があります。リクエストヘッダーから認証トークンを取得します：

```js
// auth_middleware.ts

import { IncomingHttpHeaders } from 'http';

const extractBearerTokenFromHeaders = ({ authorization }: IncomingHttpHeaders) => {
  if (!authorization) {
    throw new Error({ code: 'auth.authorization_header_missing', status: 401 });
  }

  if (!authorization.startsWith('Bearer')) {
    throw new Error({ code: 'auth.authorization_token_type_not_supported', status: 401 });
  }

  return authorization.slice(bearerTokenIdentifier.length + 1);
};
```

## トークンの検証

デモンストレーションでは、[jose](https://github.com/panva/jose) パッケージを使用して、トークンの署名、有効期限ステータス、および必要なクレームを検証します。

### 依存関係として `jose` をインストールする

```sh
npm i jose --save
```

<RetrieveOidcConfiguration />

### 認証ミドルウェアを追加

Joseの `jwtVerify` メソッドを使用して、トークンのJWS形式、トークン署名、発行元、受信者、および有効期限ステータスを検証できます。検証に失敗した場合は、例外がスローされます。

:::note
[🔐 RBAC](/docs/recipes/rbac)の場合、スコープの検証も必要です。
:::

```js
// auth-middleware.ts

import { createRemoteJWKSet, jwtVerify } from 'jose';

//...

export const verifyAuthFromRequest = async (req, res, next) => {
  // トークンを抽出する
  const token = extractBearerTokenFromHeaders(req.headers);

  const { payload } = await jwtVerify(
    token, // リクエストヘッダーから取り出された生のベアラートークン
    createRemoteJWKSet('https://<your-logto-domain>/oidc/jwks'), // Logtoサーバーから問い合わせたjwks_uriを使用してjwksを生成
    {
      // トークンの期待される発行者、Logtoサーバーによって発行される必要があります
      issuer: 'https://<your-logto-domain>/oidc',
      // 期待されるオーディエンストークンは、現在のAPIのリソース指標である必要があります
      audience: '<your request listener resource indicator>',
    }
  );

  // RBACを使用している場合
  assert(payload.scope.includes('some_scope'));

  // カスタムペイロードロジック
  userId = payload.sub;

  return next();
};
```

## APIにミドルウェアを適用する

```js
import { verifyAuthFromRequest } from '/middleware/auth-middleware.ts';

app.get('/user/:id', verifyAuthFromRequest, (req, res, next) => {
  // カスタムコード
});
```