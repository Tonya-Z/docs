---
sidebar_position: 2
---

# ⚔️ API を保護する

Logto はオフザシェルフの認可サービスで、[API リソース](../../references/resources/README.md) に認可を強制することができ、それによってプライバシー保護を強化します。

## API リソースを登録する

Logto から audience 制限付きの `access_token` を取得するには、バックエンドの API を登録する必要があります。認可リクエストを受信すると、Logto は登録された [API リソース](../../references/resources/README.md) を特定し、適切なアクセスを付与します。

API を登録するには、コンソールの API リソースセクションに移動します。組み込みリソースとして `https://tenantid.logto.app/api` と表示されるものが表示されます。このリソースは Logto の管理 API を包括し、それらが Logto の認可ユーザーのみに保護され、アクセス可能であることを保証します。

![API リソース](./assets/api-resources.png)

**API リソースの作成** ボタンをクリックし、インタラクティブなフォームに従って独自の API リソースを作成します:

- 人が読みやすい **API 名** 、このエンティティを識別するのに役立ちます。
- URI フォーマットのユニークな **API 識別子** (別名 [リソースインジケータ](../../references/resources/README.md#resource-indicator))。これは API リソースの識別を表します。

![API リソース](./assets/create-api-resource.png)

:::caution
API 識別子は一意であり、Logto の真実の唯一のソースとして使用され、作成後には**編集できません**。作成する際は注意してください。
:::

作成後、新しい API は一覧に表示されます。エンティティをクリックして API の詳細ページで管理または削除できます。

![API リソースの詳細](./assets/api-resource-details.png)

詳細な API 設定定義については、[API リソース Logto スキーマ](../../references/resources/README.md#logto-api-resource-schema) を参照してください。

:::info
Logto 管理コンソールに登録された API リソースは、すべてのアプリケーションで共有されます。
:::

### 権限と RBAC

詳細については [🔐 RBAC](/docs/recipes/rbac) を参照してください。

## API リクエストの認可トークンを検証する

Logto は、認可された各 API リクエストに対して標準の [JWT](https://datatracker.ietf.org/doc/html/rfc7519) 形式の認可トークンを発行します。このトークンは [JWS](https://datatracker.ietf.org/doc/html/rfc7515) トークンとして暗号化され、署名されます。

### JWS トークンの理解

エンコードされた [JWS](https://datatracker.ietf.org/doc/html/rfc7515) トークンは、次の3つの部分で構成されています:

- JOSEヘッダー: コードタイプとエンコーディングアルゴリズムを宣言します
- JWS ペイロード: すべてのトークンのクレームを含みます
- JWS シグネチャ: [JWK](https://datatracker.ietf.org/doc/html/rfc7517) で署名されたシグネチャ

Logto が発行した JWS ペイロードの標準スキーマ: (クレームはカスタム OIDC 設定に基づいて変化する可能性があります)

| キー       | 説明                             |
| --------- | --------------------------------- |
| jti       | ユニークな JWT ID                  |
| sub       | サブジェクト、通常はユーザー ID         |
| iat       | トークン発行時のタイムスタンプ         |
| exp       | トークンの有効期限のタイムスタンプ      |
| client_id | アプリケーション ID                  |
| iss       | トークン発行者の識別                |
| aud       | トークンの対象受信者                 |
| scope     | トークンのスコープ (権限)             |

:::info
開発中に JWT トークンを視覚的に検査するには、受信したトークンをデコードしてチェックするために [jwt.io](https://jwt.io/) を訪れることができます。本番環境でトークンを使用する場合には注意してください。これはサードパーティが提供する公開オンラインサービスであり、トークンが公開される可能性があります。
:::

### 認可トークンの検証

1. [JWT の検証](https://datatracker.ietf.org/doc/html/rfc7519#section-7.2)
2. [JWS シグネチャの検証](https://datatracker.ietf.org/doc/html/rfc7515#section-5.2)
3. トークンの発行者は `https://<your-logto-domain>/oidc` (Logto 認証サーバーによって発行)
4. トークンの対象受信者は Logto 管理コンソールに登録された現在の受信者のリソースインジケータと等しい
5. トークンは有効期限内である
6. ([🔐 RBAC](/docs/recipes/rbac/) のみ) トークンに必要な `scope` が含まれている

JWT トークンを簡単に検証およびデコードするためのさまざまなオープンソースのライブラリやパッケージがあります。言語やフレームワークに基づいて1つ選んでバックエンドアプリケーションに統合できます。次の例のいくつかを確認してください:

- [Node (Express)](./node)
- [Spring Boot](./spring-boot)
- [Python](./python)

## 参照

Logto はコードベースの OAuth 2.0 認可プロトコルを使用して API リクエストを安全にします。その戦略に興味がある場合は、OAuth 2.0 の [仕様](https://datatracker.ietf.org/doc/html/rfc6749#section-1.3.1) を参照してください。