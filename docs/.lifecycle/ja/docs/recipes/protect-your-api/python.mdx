---
sidebar_label: Python
---

import RetrieveOidcConfiguration from './fragments/_retrieve_oidc_configuration.md';

# Pythonã§APIã‚’ä¿è­·ã™ã‚‹

:::note

ç¶šè¡Œã™ã‚‹å‰ã«ã€[Logtoç®¡ç†ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§APIãƒªã‚½ãƒ¼ã‚¹ã‚’ç™»éŒ²](./README.mdx#register-the-api-resources-using-logto-admin-console)ã—ã¦ãã ã•ã„ã€‚

:::

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ™ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŠ½å‡º

```python
"""requires-auth.py
"""
def get_auth_token():
  auth = request.headers.get("Authorization", None)

  if not auth:
    raise Error({ code: 'auth.authorization_header_missing', status: 401 })

  contents = auth.split()

  if len(contents) < 2
    raise Error({code: 'auth.authorization_token_invalid_format', status: 401})

  elif contents[0] != 'Bearer'
    raise Error({code: 'auth.authorization_token_type_not_supported', status: 401})

  return contents[1]

```

## ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼

ãƒ‡ãƒ¢ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ã€Flaskã‚¢ãƒ—ãƒªã¨[jose](https://github.com/mpdavis/python-jose)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®ç½²åã€æœ‰åŠ¹æœŸé™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãŠã‚ˆã³å¿…è¦ãªã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®`require_auth`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

### ä¾å­˜é–¢ä¿‚ã¨ã—ã¦`python-jose`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Logtoã§ä½¿ç”¨ã—ã¦ã„ã‚‹æš—å·åŒ–æ–¹å¼ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`ecdsa`ï¼‰

```sh
pip install python-jose[ecdsa]
```

<RetrieveOidcConfiguration />

### èªå¯æ¤œè¨¼ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ä½œæˆ

```python
"""requires-auth.py
"""

import json
from flask import request,  _request_ctx_stack
from six.moves.urllib.request import urlopen
from functools import wraps
from jose import jwt

def requires_auth(f):
  @wraps(f)
  def decorated(*args, **kwargs):
    token = get_token_auth_header()

    # Logtoã‹ã‚‰å–å¾—ã—ãŸjwks_uriã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    jwks_uri = urlopen('https://<your-logto-domain>/oidc/jwks')

    # Logtoã‹ã‚‰å–å¾—ã—ãŸç™ºè¡Œè€…
    issuer = 'https://<your-logto-domain>/oidc'

    jwks = json.loads(jwks_uri.read())

    try:
      payload = jwt.decode(
        token,
        jwks,
        algorithms='ES256',
        audience='<your request listener resource indicator>',
        issue=issuer
        options={
          'verify_at_hash': False
        }
      )
    except Exception:
      # ä¾‹å¤–å‡¦ç†
      raise Error({code: 'invalid_token', status: 401})

      # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ‰
    _request_ctx_stack.top.user_id = payload.get('sub')

    return f(*args, **kwargs)
  return decorated

```

:::note
[ğŸ” RBAC](/docs/recipes/rbac)ã®å ´åˆã€ã‚¹ã‚³ãƒ¼ãƒ—ã®æ¤œè¨¼ã‚‚å¿…è¦ã§ã™ã€‚
:::

## APIã«ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é©ç”¨

```python
from flask import Flask
from flask_cors import cross_origin

APP = Flask(__name__)

@APP.route("/user/info")
@cross_origin(headers=["Content-Type", "Authorization"])
@requires_auth
def api:
  # APIã®ãƒ­ã‚¸ãƒƒã‚¯

```